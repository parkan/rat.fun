{"version":3,"sources":["../../src/bin/deploy.ts"],"names":[],"mappings":"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","file":"deploy.js","sourcesContent":["import \"dotenv/config\"\nimport {\n  Hex,\n  concatHex,\n  http,\n  isHex,\n  parseAbiParameters,\n  encodeAbiParameters,\n  size,\n  parseEther,\n  createClient\n} from \"viem\"\nimport { privateKeyToAccount } from \"viem/accounts\"\nimport { getRpcUrl } from \"@latticexyz/common/foundry\"\nimport {\n  ensureContractsDeployed,\n  ensureDeployer,\n  getContractAddress,\n  waitForTransactions\n} from \"@latticexyz/common/internal\"\nimport entryPointArtifact from \"@account-abstraction/contracts/artifacts/EntryPoint.json\" with { type: \"json\" }\nimport simpleAccountFactoryArtifact from \"@account-abstraction/contracts/artifacts/SimpleAccountFactory.json\" with { type: \"json\" }\nimport localPaymasterArtifact from \"@latticexyz/paymaster/out/GenerousPaymaster.sol/GenerousPaymaster.json\" with { type: \"json\" }\nimport { getChainId } from \"viem/actions\"\nimport { writeContract } from \"@latticexyz/common\"\nimport { entryPoint07Address } from \"viem/account-abstraction\"\n\n// TODO: parse env with arktype (to avoid zod dep) and throw when absent\n\nconst privateKey = process.env.PRIVATE_KEY\nif (!isHex(privateKey)) {\n  // TODO: detect anvil and automatically put this env var where it needs to go?\n  throw new Error(\n    `Missing \\`PRIVATE_KEY\\` environment variable. If you're using Anvil, run\n\n  echo \"PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80\" > .env\n\nto use a prefunded Anvil account.`\n  )\n}\nconst account = privateKeyToAccount(privateKey)\nconst rpcUrl = await getRpcUrl()\n\nconst client = createClient({ account, transport: http(rpcUrl) })\n\nconst chainId = await getChainId(client)\n\nconsole.log(\"Deploying to chain\", chainId, \"from\", account.address, \"via\", rpcUrl)\n\n// TODO: deployer address flag/env var?\nconst deployerAddress = await ensureDeployer(client)\n\n// https://github.com/eth-infinitism/account-abstraction/blob/b3bae63bd9bc0ed394dfca8668008213127adb62/hardhat.config.ts#L11\nconst entryPointSalt = \"0x90d8084deab30c2a37c45e8d47f49f2f7965183cb6990a98943ef94940681de3\"\nconst entryPointAddress = getContractAddress({\n  deployerAddress,\n  bytecode: entryPointArtifact.bytecode as Hex,\n  salt: entryPointSalt\n})\nif (entryPointAddress !== entryPoint07Address) {\n  throw new Error(\n    `Unexpected EntryPoint v0.7 address\\n\\n  Expected: ${entryPoint07Address}\\nActual: ${entryPointAddress}`\n  )\n}\n\n// Deploy entrypoint first, because following deploys need to be able to call it.\nawait ensureContractsDeployed({\n  client,\n  deployerAddress,\n  contracts: [\n    {\n      bytecode: entryPointArtifact.bytecode as Hex,\n      salt: entryPointSalt,\n      deployedBytecodeSize: size(entryPointArtifact.deployedBytecode as Hex),\n      debugLabel: \"EntryPoint v0.7\"\n    }\n  ]\n})\n\nawait ensureContractsDeployed({\n  client,\n  deployerAddress,\n  contracts: [\n    {\n      bytecode: concatHex([\n        simpleAccountFactoryArtifact.bytecode as Hex,\n        encodeAbiParameters(parseAbiParameters(\"address\"), [entryPointAddress])\n      ]),\n      deployedBytecodeSize: size(simpleAccountFactoryArtifact.deployedBytecode as Hex),\n      debugLabel: \"SimpleAccountFactory\"\n    }\n  ]\n})\n\nif (chainId === 31337) {\n  const localPaymasterBytecode = concatHex([\n    localPaymasterArtifact.bytecode.object as Hex,\n    encodeAbiParameters(parseAbiParameters(\"address\"), [entryPointAddress])\n  ])\n  const localPaymasterAddress = getContractAddress({\n    deployerAddress,\n    bytecode: localPaymasterBytecode\n  })\n\n  await ensureContractsDeployed({\n    client,\n    deployerAddress,\n    contracts: [\n      {\n        bytecode: localPaymasterBytecode,\n        deployedBytecodeSize: size(localPaymasterArtifact.deployedBytecode.object as Hex),\n        debugLabel: \"GenerousPaymaster\"\n      }\n    ]\n  })\n\n  const tx = await writeContract(client, {\n    chain: null,\n    address: entryPointAddress,\n    abi: [\n      {\n        inputs: [{ name: \"account\", type: \"address\" }],\n        name: \"depositTo\",\n        outputs: [],\n        stateMutability: \"payable\",\n        type: \"function\"\n      }\n    ],\n    functionName: \"depositTo\",\n    args: [localPaymasterAddress],\n    value: parseEther(\"100\")\n  })\n  await waitForTransactions({ client, hashes: [tx] })\n  console.log(\"\\nFunded local paymaster at:\", localPaymasterAddress, \"\\n\")\n}\n\nconsole.log(\"\\nEntryKit contracts are ready!\\n\")\nprocess.exit(0)\n"]}