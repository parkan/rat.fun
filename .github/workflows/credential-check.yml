name: Credential Check

on: [push, pull_request]

jobs:
  check-credentials:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Get full history for better scanning

      - name: Check for credentials
        run: |
          # Patterns to check for credentials
          PATTERNS=(
            "PRIVATE_KEY="
            "API_KEY="
            "TOKEN="
            "SECRET="
            "PASSWORD="
            "AWS_ACCESS_KEY_ID="
            "AWS_SECRET_ACCESS_KEY="
            "REPLICATE_API_TOKEN="
            "ANTHROPIC_API_KEY="
            "SENTRY_DSN="
            "MASTER_KEY_CODE="
            "NETLIFY_AUTH_TOKEN="
            "SANITY_TOKEN="
          )

          # Check all files in the repo
          for pattern in "${PATTERNS[@]}"; do
            if grep -r "$pattern" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.mud --exclude-dir=cache --exclude-dir=broadcast --exclude-dir=deploys --exclude-dir=docs; then
              echo "❌ Found credential pattern: $pattern"
              echo "Please remove any credentials from the repository."
              echo "Use environment variables (.env files) instead."
              exit 1
            fi
          done

          echo "✅ No credentials found"

      - name: Check for .env files
        run: |
          # Check for .env files (excluding examples)
          if find . -name ".env*" -not -name ".env.example" -not -name ".env.test" | grep -q .; then
            echo "❌ Found .env files:"
            find . -name ".env*" -not -name ".env.example" -not -name ".env.test"
            echo "Please remove .env files from the repository."
            echo "Use .env.example for template files."
            exit 1
          fi

          echo "✅ No .env files found"

      - name: Check for hardcoded env vars
        run: |
          # Check for hardcoded environment variables
          HARDCODED_PATTERNS=(
            "process.env.*="
            "import.meta.env.*="
            "API_KEY="
            "SECRET="
            "PASSWORD="
            "TOKEN="
            "PRIVATE_KEY="
            "REPLICATE_API_TOKEN="
            "ANTHROPIC_API_KEY="
            "SENTRY_DSN="
            "MASTER_KEY_CODE="
            "NETLIFY_AUTH_TOKEN="
            "SANITY_TOKEN="
          )

          for pattern in "${HARDCODED_PATTERNS[@]}"; do
            if grep -r "$pattern" . --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=.mud --exclude-dir=cache --exclude-dir=broadcast --exclude-dir=deploys --exclude-dir=docs --include="*.js" --include="*.ts" --include="*.jsx" --include="*.tsx" --include="*.svelte" --include="*.vue" --include="*.json" --include="*.md" --include="*.txt" --include="*.yml" --include="*.yaml"; then
              echo "❌ Found hardcoded env var pattern: $pattern"
              echo "Please use environment variables instead of hardcoded values."
              echo "Example: process.env.API_KEY instead of API_KEY = 'actual_key'"
              exit 1
            fi
          done

          echo "✅ No hardcoded env vars found"
